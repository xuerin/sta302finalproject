---
title: "Can GDP be predicted by standard of living factors?"
author: "Erin Xu & Dora Dong"
date: "2025-05-19"
output: 
  pdf_document:
    extra_dependencies: ["bbm"]
urlcolor: blue
---

```{r message=FALSE, echo=FALSE, warning=FALSE, include=FALSE}
packages <- c("tidyverse", "latex2exp", "gridExtra", "rvest", 
              "kableExtra", "leaps", "ggplot2", "patchwork")
lapply(packages, require, character.only = T)
set.seed(420)
```

# Load data and check if needed to clean. 
```{r}
all_data <- read.csv("life_expectancy.csv", na.strings = c("", "NA"))
anyNA(all_data)
sum(is.na(all_data))
colSums(is.na(all_data))
```

# Decide predictors 
```{r eval=FALSE}
all_data <- read.csv("life_expectancy.csv")
all_data <- na.omit(all_data)

all_data$Status <- as.factor(all_data$Status)


# Clean model
full_model <- lm(GDP ~ Life.expectancy + Status + Adult.Mortality + 
                   infant.deaths + Alcohol + percentage.expenditure + 
                   Hepatitis.B + Measles + BMI + under.five.deaths + Polio +
                   Total.expenditure + Diphtheria + HIV.AIDS + Population +
                   thinness..1.19.years + thinness.5.9.years +
                   Income.composition.of.resources + Schooling,
                 data = all_data)
summary(full_model)

step_model <- step(full_model, direction = "both")
summary(step_model)
```

# Best subset selection
```{r, fig.width=10, fig.height=7}
best_model <- regsubsets(Life.expectancy ~ GDP + Status + Adult.Mortality + 
                           infant.deaths + Alcohol +
                           percentage.expenditure + Hepatitis.B + Measles + 
                           BMI + under.five.deaths + Polio +
                           Total.expenditure + Diphtheria + HIV.AIDS + 
                           Population + thinness..1.19.years + 
                           thinness.5.9.years + Income.composition.of.resources 
                          + Schooling, data = all_data, nvmax = 10)

# Summary and plot
best_summary <- summary(best_model)
plot(best_model, scale = "adjr2")
```
We propose the following multiple linear regression model:
$$GDP = E(GDP) + e =$$
$$b_0 + b_1PercentageExpenditure + b_2Polio + b_3Population + b_4IncomeCompositionofResources + b_5Schooling + b_6Status$$

# Get the response and predictors. 
```{r}
all_data <- read.csv("life_expectancy.csv")
all_data <- na.omit(all_data)
all_data$log_GDP <- log(all_data$GDP)

response <- all_data$log_GDP
x0 <- all_data$percentage.expenditure
x1 <- all_data$Polio
x2 <- all_data$Population
x3 <- all_data$Income.composition.of.resources
x4 <- all_data$Schooling

all_data$Status <- as.factor(all_data$Status)

model <- lm(response ~ Status + x0 + x1 + x2 + x3 + x4, data = all_data)
summary(model)
```
We estimate the deterministic model as $$\hat{GDP} = \hat{b_0} + \hat{b_1}PercentageExpenditure +\hat{b_2}Polio + $$
$$\hat{b_3}Population +\hat{b_4}IncomeCompositionofResources +\hat{b_5}Schooling +\hat{b_6}Status $$ 
by using the $lm$ function to find the values of the coefficients that minimize the RSS. 

# Residual plots
```{r, fig.width=13, fig.height=8,}
par(mfrow = c(2, 2))
plot(model)
```

# Residual VS each predictor (Regression assumptions)
```{r, fig.width=12, fig.height=8}
all_data$residuals <- resid(model)
all_data$fitted <- fitted(model)

p1 <- ggplot(all_data, aes(x = `percentage.expenditure`, y = residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals vs Percentage Expenditure")

p2 <- ggplot(all_data, aes(x = Polio, y = residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals vs Polio")

p3 <- ggplot(all_data, aes(x = Population, y = residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals vs Population")

p4 <- ggplot(all_data, aes(x = `Income.composition.of.resources`, 
                           y = residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals vs Income Composition")

p5 <- ggplot(all_data, aes(x = Schooling, y = residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals vs Schooling")

p6 <- ggplot(all_data, aes(x = as.factor(Status), y = residuals)) +
  geom_jitter(width = 0.2, alpha = 0.6, color = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_x_discrete(labels = c("Developing", "Developed")) +
  labs(title = "Residuals vs Status",
       x = "Status",
       y = "Residuals")

(p1 | p2 | p3) / (p4 | p5 | p6)
```

# Residual VS Fitted plot (Regression assumptions)
```{r}
qq_plot <- ggplot(all_data, aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line(color = "red", linetype = "dashed") +
  labs(title = "Q-Q Plot of Residuals")

hist_plot <- ggplot(all_data, aes(x = residuals)) +
  geom_histogram(binwidth = 500, fill = "steelblue", color = "white", 
                 alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Histogram of Residuals", x = "Residuals", y = "Count")

qq_plot | hist_plot
```

# Check for influential points, high leverage points
```{r}
# Set threshold
predictors <- c("Status", "percentage.expenditure", "Polio",
                "Total.expenditure", "Income.composition.of.resources", 
                "Schooling")
cook_thresh <- 4 / nrow(all_data)
lev_thresh <- 2 * mean(all_data$leverage)

# Logical vector for flagged rows
flagged_index <- all_data$cooksD > cook_thresh | all_data$leverage > lev_thresh

# Directly subset with logical index
print(all_data[flagged_index, c("Country", predictors)])
```
