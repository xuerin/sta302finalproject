---
title:  "Modeling GDP Using Health and Socioeconomic Indicators"
author: "Erin Xu, Dora Dong, Shencen Cai, Sharon Lam"
date: "2025-06-12"
output: 
  pdf_document:
    extra_dependencies: ["bbm"]
urlcolor: blue
bibliography: references.bib
nocite: '@*'
link-citations: true
---
```{r message=FALSE, echo=FALSE, warning=FALSE, include=FALSE}
packages <- c("tidyverse", "latex2exp", "gridExtra", "rvest", 
              "kableExtra", "leaps", "ggplot2", "patchwork", "car", "MASS")
lapply(packages, require, character.only = T)
set.seed(320)
all_data <- read.csv("life_expectancy.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
all_data <- read.csv("life_expectancy.csv")
all_data <- na.omit(all_data)
all_data$Status <- as.factor(all_data$Status)

hist(all_data$Population)
hist(all_data$Schooling)
hist(all_data$Polio)
hist(all_data$Total.expenditure)
hist(all_data$Income.composition.of.resources)

# Cleaned full model
#### This is the original model #######
full_model <- lm(GDP ~ Life.expectancy + Status + Adult.Mortality + 
                   infant.deaths + Alcohol + Total.expenditure + percentage.expenditure+
                   Hepatitis.B + Measles + BMI + under.five.deaths + Polio
                   + Diphtheria + HIV.AIDS + Population +
                   thinness..1.19.years + thinness.5.9.years +
                   Income.composition.of.resources + Schooling,
                 data = all_data)
summary(full_model)

step_model <- step(full_model, direction = "both")
summary(step_model)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

all_data <- read.csv("life_expectancy.csv")
all_data <- na.omit(all_data)
all_data$Status <- as.factor(all_data$Status)

### model1 result of stepwise ####

model1 <- lm(GDP ~ Status + Total.expenditure + Polio+ percentage.expenditure + Income.composition.of.resources
                  + Schooling , data = all_data)
summary(model1)

par(mfrow = c(2, 2))
plot(model1)

## model2 replace percentage expenditure with population for meaningful interpretation of model coefficients

model2 <- lm(GDP ~ Status + Total.expenditure + Polio + Population + Income.composition.of.resources
                  + Schooling , data = all_data)
summary(model2)

par(mfrow = c(2, 2))
plot(model2)

## Model 3 Box_Cox tansformed response variable y

bc <- boxcox(model2, plotit = TRUE)
(lambda_optimal <- bc$x[which.max(bc$y)])

all_data$bc_GDP <- (all_data$GDP^0.1010101 - 1)/0.1010101
all_data$Status <- as.factor(all_data$Status)

model3 <- lm(bc_GDP ~ Status + Total.expenditure + Polio + Population 
             + Income.composition.of.resources  + Schooling, data = all_data)
summary(model3)

par(mfrow = c(2, 2))
plot(model3)


# Model 4 Only squared Polio and Income

model4 <- lm(GDP ~ Status + Total.expenditure
                          + I(Polio^2) + Population + I(Income.composition.of.resources^2)
                              + Schooling, data = all_data)
summary(model4)

par(mfrow = c(2, 2))
plot(model4)


# Model 5 Combination of box-cox and squared

model5 <- lm(bc_GDP ~ Status + Total.expenditure + I(Polio^2)
             + I(Population^2)
             + Income.composition.of.resources
             + Schooling,
             data = all_data)
summary(model5)

par(mfrow = c(2, 2))
plot(model5)


# Model 6 (Final Model)
# the best model when combine box-cox and squared

model6 <- lm(bc_GDP ~ Status +I(Total.expenditure^2) +Polio
             + I(log(Population))
             + Income.composition.of.resources
             + I(Schooling^2),
             data = all_data)

summary(model6)

par(mfrow = c(2, 2))
plot(model6)

#check multicolinearity
vif(model6)

#check AIC & BIC for all model we have

aic_results <- AIC(model1, model2, model3, model4, model5, model6)
bic_results <- BIC(model1, model2, model3, model4, model5, model6)
print(aic_results)
print(bic_results)


# some plots
mod.resid <- resid(model6)
mod.fitted <- fitted(model6)
mod.sresid <- rstandard(model6)

## Response vs. Fitted plot
plot(mod.fitted,all_data$bc_GDP,xlab="Fitted",ylab="GDP",
     main="Fitted vs Response")
abline(a=0,b=1,col="red",lwd=2)

## Residuals vs Fitted plot
plot(mod.fitted,mod.resid,xlab="Fitted",ylab="Residuals",
     main="Fitted vs. Residuals")
abline(h=0,col="blue",lwd=2)

## QQ plot
qqnorm(mod.sresid); qqline(mod.sresid)

## check leverage point/ influential point/ outliers

## Leverage points
mod.hii <- hatvalues(model6)
plot(mod.hii,type="h",ylab='hii',main="Leverage values")
## Define the cutoff for leverage points
cutoff.leveragepoints <- 2*(6+1)/nrow(all_data)
cutoff.leveragepoints.bis <- 3*(6+1)/nrow(all_data)
abline(h=cutoff.leveragepoints,col="red")
abline(h=cutoff.leveragepoints.bis,col="blue")
abline(h=0.5,col="green")
mod.hii
which(mod.hii>cutoff.leveragepoints)

## Outliers
plot(mod.sresid,type="h")
abline(h=4,col="red")
abline(h=-4,col="red")
which(abs(mod.sresid)>4)

## Influential points

## 1. Cook's distance
mod.dii <- cooks.distance(model6)
plot(mod.dii,type="h",ylab="Dii")
cutoff_dii <- qf(0.5,df1=7,df2=(nrow(all_data)-6-1))
abline(h=cutoff_dii,col="red")
abline(h=1,col="blue")
abline(h=4/nrow(all_data),col="green")
which(mod.dii>(4/nrow(all_data)))
## Based on the cutoff 4/n

## 2. Difference in fitted values
mod.dffits <- dffits(model6)
plot(mod.dffits,type="h",ylab="DFFITS")
cutoff.dffits <- 2*sqrt(7/nrow(all_data))
abline(h=cutoff.dffits,col="red")
abline(h=-cutoff.dffits,col="red")
which(abs(mod.dffits)>cutoff.dffits)

## remove outliers

remove_invalid <- unique(c(
  which(abs(mod.sresid)>4)
))

clean_data6 <- all_data[-remove_invalid, ]

# clean model

clean_model6 <- lm(bc_GDP ~ Status 
             +I(Total.expenditure^2)
             + Polio
             + I(log(Population))
             + Income.composition.of.resources
             + I(Schooling^2),
             data = clean_data6)
summary(clean_model6)

par(mfrow = c(2, 2))
plot(clean_model6)
